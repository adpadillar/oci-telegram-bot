version: 0.1
component: build
timeoutInSeconds: 1800
shell: bash
env:
  variables:
    # Docker Registry Information
    DOCKER_REGISTRY: "${region-code}.ocir.io"
    NAMESPACE: "${namespace}"

    # Repository Information
    BACKEND_REPO: "${namespace}/todolistapp-springboot"

    # Dockerfile Paths
    BACKEND_DOCKERFILE_PATH: "Dockerfile"

    # Build Contexts
    BACKEND_CONTEXT: "."

  exportedVariables:
    - BACKEND_IMAGE_TAG

steps:
  # Step 1: Login to OCIR
  - type: Command
    name: "Login to OCIR"
    timeoutInSeconds: 60
    command: |
      echo "Logging into OCIR..."
      echo "${OCIR_PASSWORD}" | docker login ${DOCKER_REGISTRY} -u "${NAMESPACE}/oracleidentitycloudservice/${OCIR_USER}" --password-stdin
    onFailure:
      - type: Command
        command: |
          echo "Failed to login to OCIR"
          exit 1

  # Step 2: Build and Push Backend Image
  - type: Command
    name: "Build and Push Backend Image"
    timeoutInSeconds: 600
    command: |
      echo "Building backend image..."
      cd ${OCI_PRIMARY_SOURCE_DIR}

      # Generate unique tag for backend image
      export BACKEND_IMAGE_TAG="${DOCKER_REGISTRY}/${BACKEND_REPO}:${OCI_BUILD_RUN_ID}"
      echo "Backend image tag: ${BACKEND_IMAGE_TAG}"

      # Build the image
      docker build -t ${BACKEND_IMAGE_TAG} -f ${BACKEND_DOCKERFILE_PATH} ${BACKEND_CONTEXT}

      # Push the image
      docker push ${BACKEND_IMAGE_TAG}
      echo "Backend image pushed: ${BACKEND_IMAGE_TAG}"
    onFailure:
      - type: Command
        command: |
          echo "Failed to build or push backend image"
          exit 1

  # Step 3: Prepare Kubernetes Deployment File
  - type: Command
    name: "Prepare Deployment File"
    timeoutInSeconds: 300
    command: |
      echo "Preparing deployment file..."
      cd ${OCI_PRIMARY_SOURCE_DIR}

      # Copy the deployment file
      cp src/main/resources/todolistapp-springboot.yaml deployment.yaml

      # Replace image placeholders
      sed -i "s|%DOCKER_REGISTRY%/todolistapp-springboot:0.1|${BACKEND_IMAGE_TAG}|g" deployment.yaml
      sed -i "s|%TODO_PDB_NAME%|${TODO_PDB_NAME}|g" deployment.yaml
      sed -i "s|%OCI_REGION%|${OCI_REGION}|g" deployment.yaml
      sed -i "s|%UI_USERNAME%|${UI_USERNAME}|g" deployment.yaml

      echo "Deployment file prepared"
    onFailure:
      - type: Command
        command: |
          echo "Failed to prepare deployment file"
          exit 1

outputArtifacts:
  - name: deployment-manifest
    type: KUBERNETES_MANIFEST
    location: deployment.yaml
